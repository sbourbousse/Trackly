version: '3.8'

services:
  # Base de données PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: trackly-postgres
    environment:
      POSTGRES_DB: trackly
      POSTGRES_USER: trackly
      POSTGRES_PASSWORD: admin
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trackly"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend .NET
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: trackly-backend
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://0.0.0.0:8080
      - ConnectionStrings__TracklyDb=Host=postgres;Port=5432;Database=trackly;Username=trackly;Password=admin
      - Cors__AllowedOrigins__0=http://localhost:5173
      - Cors__AllowedOrigins__1=http://localhost:5175
    ports:
      - "5257:8080"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Mount pour le développement (optionnel)
      - ./backend:/src
      - /src/bin
      - /src/obj

  # Frontend Business (SvelteKit)
  frontend-business:
    build:
      context: ./frontend-business
      dockerfile: Dockerfile
    container_name: trackly-frontend-business
    environment:
      - NODE_ENV=production
      - PORT=8080
      - PUBLIC_API_BASE_URL=http://localhost:5257
      - PUBLIC_SIGNALR_URL=http://localhost:5257/hubs/tracking
    ports:
      - "5173:8080"
    depends_on:
      - backend

  # Frontend Driver (Vite SPA)
  frontend-driver:
    build:
      context: ./frontend-driver
      dockerfile: Dockerfile
    container_name: trackly-frontend-driver
    environment:
      - NODE_ENV=production
      - PORT=8080
      - PUBLIC_API_BASE_URL=http://localhost:5257
      - PUBLIC_SIGNALR_URL=http://localhost:5257/hubs/tracking
    ports:
      - "5175:8080"
    depends_on:
      - backend

volumes:
  postgres_data:
