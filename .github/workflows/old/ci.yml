name: CI (Turborepo)

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

jobs:
  build-and-lint:
    name: Build & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      # - name: Lint
      #   run: npm run lint

  # Redeploy Railway (environnement main) - utilise les secrets de l'environnement
  # NOTE: Seul le backend est déployé sur Railway, les frontends sont sur Vercel
  deploy-railway:
    name: Redeploy Railway Services
    needs: build-and-lint
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: main  # ← Utilise l'environnement "main" pour les secrets Railway
    steps:
      - name: Redeploy backend
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID_BACKEND }}
        run: |
          resp=$(curl -sS -w '\n%{http_code}' -X POST "https://backboard.railway.com/graphql/v2" \
            -H "Authorization: Bearer ${RAILWAY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "{\"query\":\"mutation serviceInstanceRedeploy($environmentId: String!, $serviceId: String!) { serviceInstanceRedeploy(environmentId: $environmentId, serviceId: $serviceId) }\",\"variables\":{\"environmentId\":\"${RAILWAY_ENVIRONMENT_ID}\",\"serviceId\":\"${RAILWAY_SERVICE_ID}\"}}")
          code=$(echo "$resp" | tail -n1)
          body=$(echo "$resp" | sed '$d')
          echo "$body" | jq . 2>/dev/null || echo "$body"
          if [ "$code" != "200" ]; then echo "Redeploy backend failed (HTTP $code)" && exit 1; fi

      # Les frontends sont maintenant déployés sur Vercel via workflow manuel
      # - name: Redeploy frontend-business
      #   ...

      # - name: Redeploy frontend-driver
      #   ...
